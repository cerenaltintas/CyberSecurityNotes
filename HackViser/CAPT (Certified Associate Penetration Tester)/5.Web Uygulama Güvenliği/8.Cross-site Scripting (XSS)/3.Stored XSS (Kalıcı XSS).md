Stored XSS, zararlı bir scriptin bir web uygulamasının veri tabanında saklandığı ve daha sonra sayfa görüntülenmek istendiğinde kullanıcıların tarayıcılarında çalıştırıldığı bir saldırı türüdür. Bu tür saldırılar genellikle mesajlaşma uygulamaları, forum gönderileri, yorumlar veya kullanıcı profilleri gibi kullanıcı tarafından sağlanan verilerin saklandığı durumlarda gerçekleşir. Reflected XSS zafiyeti ile arasındaki fark veri tabanında depolanmasıdır.

Bu zafiyetin bulunduğu bir web uygulamasında saldırı için kullanıcının XSS payload'u içeren bir bağlantıya tıklamasına gerek duyulmamaktadır. XSS payload'ları sayfa içerisinde kalıcı olarak var olduğu için tetiklenmesi daha kolay ve daha geniş etkileri olan bir saldırı türüdür. Bu sebepten dolayı Reflected XSS'e göre daha kritik bir zafiyet olarak görülmektedir. Binlerce kişiye bağlantı tıklatmak yerine sayfa içerisinde veri tabanından gelen bir zararlı script ile sayfayı ziyaret eden tüm kullanıcıların tarayıcısında kod çalıştırmaya imkan sunabilmektedir.

### Stored XSS Saldırısı Örneği

Birden fazla kullanıcı tarafından kullanılan bir mesajlaşma uygulamasında Stored XSS zafiyetinin bulunması mümkün olabilmektedir. Mesajların diğer kullanıcılara gösterilmesi, sayfa yenilendiğinde ya da başka bir zaman yeniden ziyaret edildiğinde mesajların tekrar görüntülenebilmesi için gönderilen mesajlar sunucu tarafından işlenip veritabanına kaydedilir.

Uygulamanın İncelenmesi

![](https://storage.hackviser.com/file/hackviser-prod/trainings/sections/images/bf891dd3-4a79-428b-8012-90927de1ccd2/stored-xss-messages-hello-world-f159ed558.webp)

Burada görülen mesajlaşma uygulamasında kısa bir mesaj gönderilmiştir.

```auto
POST /index.php HTTP/1.1
Host: example.com
Cookie: PHPSESSID=jl5kamgcplionfan0kkjhcujh3
Content-Length: 19
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.60 Safari/537.36

message=Hello+World
```

Gönderilen HTTP isteği incelendiğinde POST methodu ile "message" isimli bir veri gönderilmektedir.

Zafiyetin Tespit Edilmesi

![](https://storage.hackviser.com/file/hackviser-prod/trainings/sections/images/bf891dd3-4a79-428b-8012-90927de1ccd2/stored-xss-document-cookie-payload-6b39dcc13.webp)

Tespit edilen girdi alanına oturum ve çerez bilgilerini uyarı kutusunda bastıran basit bir JavaScript kodu yazılmıştır.

![](https://storage.hackviser.com/file/hackviser-prod/trainings/sections/images/bf891dd3-4a79-428b-8012-90927de1ccd2/stored-xss-session-1f0cef8e3.webp)

Sayfa ziyaret edildiğinde "PHPSESSID" isimli bir oturum değerinin uyarı kutusunda bastırıldığı görülmektedir. Burada gönderilen mesaj veri tabanında saklandığı ve ekstra bir GET parametresinden alınan değere ihtiyaç duyulmadığı için Stored XSS zafiyeti adı verilmiştir.

```auto
POST /index.php HTTP/1.1
Host: example.com
Cookie: PHPSESSID=jl5kamgcplionfan0kkjhcujh3
Content-Length: 19
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.6367.60 Safari/537.36

message=<script>alert(document.cookie)</script>
```

### Kaynak Kod Analizi

Zafiyetli Kod Örneği

```auto
<?php 
    $messages = $db->query("SELECT * FROM messages");
    if ($messages) {
        while ($row = $messages->fetch(PDO::FETCH_ASSOC)) {
            echo "<div>" . $row['message'] . "</div>";
        }
    }
?>
```

Bu PHP kod parçası, veri tabanından mesajları çekip doğrudan HTML içerisinde göstermektedir. Bu durum, Stored XSS saldırılarına açık bir yapı oluşturur.

Güvenli Kod Örneği

```auto
<?php 
    $messages = $db->query("SELECT * FROM messages");
    if ($messages) {
        while ($row = $messages->fetch(PDO::FETCH_ASSOC)) {
            echo "<div>" .  htmlspecialchars($row['message']) . "</div>";
        }
    }
?>
```

Bu PHP kod parçası, **htmlspecialchars** fonksiyonu kullanılarak yorumlar, HTML özel karakterler içeriyorsa bu karakterler tarayıcı tarafından yorumlanmadan önce dönüştürülür. Bu düzenleme ile Stored XSS saldırıları büyük ölçüde önlenebilir.