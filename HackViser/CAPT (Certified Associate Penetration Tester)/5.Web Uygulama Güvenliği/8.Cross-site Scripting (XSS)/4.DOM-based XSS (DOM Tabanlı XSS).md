DOM-based XSS, bir web sayfasının tarayıcı tarafında yürütülen JavaScript kodlarının kötüye kullanılmasıyla gerçekleşir. Bu saldırı tipinde, zararlı scriptler doğrudan sayfanın HTML koduna yerleştirilmez; bunun yerine, kullanıcı etkileşimleri veya sayfa içi nesneler üzerinden DOM'u manipüle ederek gerçekleşir. Tetiklenme ve saldırı yöntemi Reflected, Stored XSS ile aynıdır tek fark DOM'un manipüle edilmesidir.

Bu tür XSS saldırıları, bir web sayfasının JavaScript kodlarının, kötü amaçlı verileri alıp dinamik kod yürütmeyi destekleyen fonksiyonlara (örneğin eval() veya innerHTML) aktardığı durumlarda meydana gelir.

eval()

: Bu JavaScript fonksiyonu, kendisine verilen string ifadeyi JavaScript kodu olarak değerlendirir ve çalıştırır.

```auto
var userInput = 'console.log(1)';
eval(userInput); // output : 1
```

Kullanıcı girdisi olarak verilen

console.log(1)

string'i

eval()

tarafından değerlendirilir ve sonucunda konsola

1

değeri yazdırılır.

innerHTML

: Bir HTML elementinin içeriğini almak veya ayarlamak için kullanılan bir özellik olup, bu özellik üzerinden yapılan atamalarla dinamik olarak sayfanın HTML yapısı değiştirilebilir.

```auto
document.getElementById('example').innerHTML = 'Hello, World!';
```

id

si 'example' olan HTML elementinin içeriği,

innerHTML

özelliği kullanılarak

Hello, World!

ile güncellenir. Bu sayede, belirtilen elementin içeriği dinamik bir şekilde değiştirilmiş olur.

### Document Object Model (DOM)

Document Object Model (DOM), bir web belgesinin yapısını, stilini ve içeriğini programatik olarak erişilebilir ve düzenlenebilir bir formatta temsil eden bir programlama arayüzüdür. HTML ve XML belgeleri için bir standarttır ve web sayfalarının dinamik içerikle güncellenmesini sağlar. DOM, belgenin her bir parçasını bir düğüm olarak modelleyen bir ağaç yapısı olarak düzenlenir. Bu yapının temel bileşenleri şu şekilde açıklanabilir:

DOM Yapısı

- **Düğümler (Nodes):** Bir DOM ağacında, her bir element, metin, yorum ve diğer türler düğüm olarak temsil edilir. Örneğin, HTML belgesindeki 
    
    <div>
    
    , 
    
    <p>
    
    , 
    
    <span>
    
     gibi her etiket bir eleman düğümüdür.
- **Öznitelikler (Attributes):** Öğelerin öznitelikleri (örneğin, 
    
    class
    
    , 
    
    id
    
    , 
    
    style
    
    ), bu öğelere bağlı özel bilgileri taşır ve düğüm özellikleri olarak erişilebilir.
- **Metin Düğümleri:** HTML belgesindeki metin içerikleri, bu metni içeren elementlerin çocukları olarak metin düğümleri halinde saklanır.

DOM ve JavaScript

DOM, JavaScript ile sıkça kullanılır. JavaScript, DOM API'lerini kullanarak bir web sayfasının yapısını, stilini ve içeriğini dinamik olarak değiştirebilir. Bu, sayfa yüklendikten sonra bile sayfa içeriğini güncelleme yeteneği sağlar. JavaScript ile DOM manipülasyonu şunları içerebilir:

- **Eleman Ekleme/Silme:** Sayfaya yeni HTML elemanları eklemek veya mevcut olanları silmek.
- **Öznitelik Değiştirme:** Elemanların sınıflarını, stillerini veya diğer özniteliklerini güncellemek.
- **Olay Yönetimi:** Elemanlara olay dinleyicileri ekleyerek kullanıcı etkileşimlerine yanıt vermek (örneğin, tıklamalar, fare hareketleri).

DOM'un Önemi

DOM, web geliştiricilerine, kullanıcı etkileşimlerine dinamik yanıtlar vermek ve içerikleri gerçek zamanlı olarak güncellemek için güçlü araçlar sağlar. Örneğin, bir kullanıcı form doldurduğunda veya bir butona tıkladığında, JavaScript kullanarak DOM üzerinde değişiklikler yapılabilir, bu da sayfanın tamamını yeniden yüklemeye gerek kalmadan güncellenmesini sağlar.

DOM, modern web uygulamalarının dinamik ve etkileşimli olmasının temelini oluşturur ve web teknolojileri içinde merkezi bir role sahiptir.

### DOM-based XSS Saldırısı Örnekleri

DOM tabanlı XSS, DOM'un client-side'da JavaScript tarafından manipüle edilmesiyle gerçekleşir. Bu tür XSS zafiyeti, sayfa sunucudan yüklenirken değil, client tarafındaki scriptler yürütülürken meydana gelir.

Bazı yaygın örnekler, kaynak kodları ve nasıl istismar edilebilecekleri hakkında aşağıda örnekler verilmiştir:

1. URL Fragment'ten DOM'a Script Enjekte Etme

**Kaynak Kod:**

```auto
document.getElementById('output').innerHTML = window.location.hash.substring(1);
```

**Payload:**

```auto
https://example.com#<script>alert(1)</script>
```

Bu örnekte, sayfanın URL'sinin fragment kısmı (

#<script>alert(1)</script>

) doğrudan bir HTML elementinin

innerHTML

özelliğine atanmaktadır. Bu, tarayıcıda JavaScript'in çalışmasına neden olur.

2. eval Fonksiyonunu Manipüle Ederek XSS

**Kaynak Kod:**

```auto
window.onload = function() {
    const productId = new URLSearchParams(window.location.search).get('id');
    eval('getProduct('+ productId.toString()+')');
}
```

**Payload:**

```auto
https://example.com/products?id=');alert(1)//
```

Bu kod, sayfa yüklendiğinde URL'den id parametresini alır ve

eval()

fonksiyonu aracılığıyla getProduct() fonksiyonunu çağırır. Ancak, bu kullanım sayesinde kodun içerisine JavaScript kodu dahil edilebilmektedir.

Bu payload, URL'deki

id

parametresinin kapanma paranteziyle sona erdirilmesiyle başlar (

'

). Daha sonra

);

ifadesi, mevcut

eval()

çağrısını sonlandırır ve ardından

alert(1)

ile bir JavaScript

alert

kutusu çağrılır. Son olarak,

//

işareti, URL'de bir yorum satırı oluşturur ve bundan sonra gelen her şeyi JavaScript yorumlayıcısı tarafından dikkate alınmaz hale getirir.

Sonuç olarak, sayfa yüklendiğinde,

eval()

fonksiyonu aracılığıyla JavaScript kodu çalıştırılır ve

alert(1)

ifadesi sayesinde tarayıcıda bir uyarı kutusu görüntülenir.

3. innerHTML ile XSS

**Kaynak Kod:**

```auto
document.getElementById('content').innerHTML = unescape(location.search.substring(1));
```

**Payload:**

```auto
https://example.com?%3Cscript%3Ealert(1)%3C/script%3E
```

Bu senaryoda, kullanıcı girdisi (

location.search

) doğrudan

innerHTML

ile bir elemente eklenir. Eğer girdi zararlı bir script içeriyorsa, bu script sayfada yürütülür.

4. onerror Event'i Kullanarak XSS

**Kaynak Kod:**

```auto
<img src="" id="image">
<script>
  document.getElementById('image').src = location.hash.substring(1);
</script>
```

**Payload:**

```auto
https://example.com#invalid-image" onerror="alert(1)
```

Bu durumda, bir resim elementinin

src

özelliği URL'nin hash kısmı ile ayarlanmaktadır. Eğer hash içinde

onerror

olayı tetikleyecek şekilde manipüle edilmiş bir URL verilirse, bu JavaScript kodunun çalışmasını sağlar.

### DOM-based XSS Saldırısı Uygulaması

Uygulamanın İncelenmesi

![](https://storage.hackviser.com/file/hackviser-prod/trainings/sections/images/72c96903-30fc-450d-9f4c-8184e9226870/dom-based-xss-normal-5cb621279.webp)

Yükseklik ve taban değerleri alarak üçgen alanı hesaplayan bir uygulama olduğu görülmektedir. Çalışma mantığını anlamak için değerler girilerek çalışması anlaşılmaya çalışmaktadır.

**Payload:**

```auto
https://example.com/?height=5&base=12
```

**Etkilenen Kod:**

```auto
<script>
  var height = 5;
  var base = 12;
  var ans = base * height / 2;
  document.getElementById("answer").innerHTML = "<b>Area:</b> " + ans;
</script>
```

Tarayıcının geliştirici seçenekleri (F12) aracılığıyla veri girişi yapılan kısmın kaynak kodları incelendiğinde HTML içerisinde JavaScript kodları ile

height

ve

base

isimli değişkenlere atanan değerlerin bulunduğu görülmektedir. Burası istismar edilebilir bir nokta olarak görülmüştür.

Zafiyetin Tespit Edilmesi

![](https://storage.hackviser.com/file/hackviser-prod/trainings/sections/images/72c96903-30fc-450d-9f4c-8184e9226870/dom-based-xss-payload-80facdadb.webp)

Yükseklik değer girişi alanına, sayfada uyarı kutusu çıkartan ve içerisinde 1 yazdıran payload yazılmıştır.

**Payload:**

```auto
https://example.com/?height=5; alert(1)&base=12
```

**Etkilenen Kod:**

```auto
<script>
  var height = 5;alert(1);
  var base = 12;
  var ans = base * height / 2;
  document.getElementById("answer").innerHTML = "<b>Area:</b> " + ans;
</script>
```

Girilen payload ile

height

değişkeni

;

ile kapatılıp

alert(1);

fonksiyonu dahil edilmiştir.

![](https://storage.hackviser.com/file/hackviser-prod/trainings/sections/images/72c96903-30fc-450d-9f4c-8184e9226870/dom-based-xss-alert-5e41083a3.webp)

Kaynak Kod Analizi

Zafiyetin temel sebebi, kullanıcı girdisinin yeterli kontrolden veya filtreden geçirilmeden doğrudan tarayıcıda gösterilmesidir. Bu durum, güvenlik açıklarına ve özellikle XSS saldırılarına yol açabilir.

Zafiyetli Kod Örneği

```auto
<?php
    if (isset($_GET['base']) && isset($_GET['height'])) {
        echo '<div class="alert alert-success" id="answer"></div>';
        echo '<script>';
        echo 'var height = ' . $_GET['height'] . ';';
        echo 'var base = ' . $_GET['base'] . ';';
        echo 'var ans = base * height / 2;';
        echo 'document.getElementById("answer").innerHTML = "<b>Area:</b> " + ans;';
        echo '</script>';
    }
?>
```

Bu kod parçası, kullanıcıdan alınan

base

ve

height

değerlerini doğrudan JavaScript koduna ekliyor. Eğer bu parametreler zararlı içerikler barındırıyorsa, bu içerikler tarayıcıda çalıştırılabilir ve XSS saldırısına neden olabilir.

Güvenli Kod Örneği

```auto
<?php
    if (isset($_GET['base']) && isset($_GET['height'])) {
        $base = htmlspecialchars($_GET['base'], ENT_QUOTES, 'UTF-8');
        $height = htmlspecialchars($_GET['height'], ENT_QUOTES, 'UTF-8');

        echo '<div class="alert alert-success" id="answer"></div>';
        echo '<script>';
        echo 'var height = ' . $height . ';';
        echo 'var base = ' . $base . ';';
        echo 'var ans = base * height / 2;';
        echo 'document.getElementById("answer").innerHTML = "<b>Area:</b> " + ans;';
        echo '</script>';
    }
?>
```

Bu revize edilmiş kodda,

htmlspecialchars

fonksiyonu kullanılarak, kullanıcı girdileri HTML özel karakterlere dönüştürülerek XSS saldırılarına karşı koruma sağlanmıştır. Bu fonksiyon, HTML'e özgü özel karakterleri (

<

,

>

,

&

,

"

,

'

gibi) onların HTML entitelerine (

&lt;

,

&gt;

,

&amp;

,

&quot;

,

&#039;

gibi) dönüştürür, böylece bu karakterler tarayıcı tarafından yorumlanmadan düz metin olarak gösterilir. Bu yöntemle, kullanıcı girdisi ne olursa olsun, kötü niyetli scriptler çalıştırılamaz.